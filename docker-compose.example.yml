version: '3.8'

services:
    # PostgreSQL Database
    db:
        image: postgres:15-alpine
        container_name: smartcity_db
        volumes:
            - postgres_data:/var/lib/postgresql/data
        environment:
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        ports:
            - '5432:5432'
        networks:
            - smartcity_network
        restart: unless-stopped
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
            interval: 10s
            timeout: 5s
            retries: 5

    # Django Backend
    backend:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: smartcity_backend
        volumes:
            - ./media:/app/media
            - static_volume:/app/staticfiles
        environment:
            - DATABASE_URL=${DATABASE_URL}
            - SECRET_KEY=${SECRET_KEY}
            - DEBUG=${DEBUG}
            - ALLOWED_HOSTS=${ALLOWED_HOSTS}
            - N8N_TRAFFIC_WEBHOOK=${N8N_TRAFFIC_WEBHOOK}
            - N8N_REPORT_WEBHOOK=${N8N_REPORT_WEBHOOK}
            - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
        ports:
            - '8000:8000'
        depends_on:
            db:
                condition: service_healthy
        networks:
            - smartcity_network
        restart: unless-stopped

    # n8n Workflow Automation
    n8n:
        image: n8nio/n8n:latest
        container_name: smartcity_n8n
        volumes:
            - n8n_data:/home/node/.n8n
            - ./n8n_workflows:/workflows
        environment:
            - N8N_BASIC_AUTH_ACTIVE=true
            - N8N_BASIC_AUTH_USER=admin
            - N8N_BASIC_AUTH_PASSWORD=changeme_secure_password
            - N8N_HOST=0.0.0.0
            - N8N_PORT=5678
            - N8N_PROTOCOL=http
            - WEBHOOK_URL=http://your-vps-ip:5678/
        ports:
            - '5678:5678'
        networks:
            - smartcity_network
        restart: unless-stopped

    # Nginx (Optional - for production)
    # Uncomment if you want to use Nginx as reverse proxy
    # nginx:
    #   image: nginx:alpine
    #   container_name: smartcity_nginx
    #   volumes:
    #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
    #     - static_volume:/app/staticfiles:ro
    #     - ./media:/app/media:ro
    #   ports:
    #     - "80:80"
    #     - "443:443"
    #   depends_on:
    #     - backend
    #   networks:
    #     - smartcity_network
    #   restart: unless-stopped

volumes:
    postgres_data:
    n8n_data:
    static_volume:

networks:
    smartcity_network:
        driver: bridge
